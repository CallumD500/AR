<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Location-based WebAR - Explore 3D cans placed at real-world GPS coordinates">
    <title>Location-Based AR - Can Experience</title>

    <!-- A-Frame and AR.js Location-Based -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            overflow: hidden;
        }

        .instructions {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            z-index: 1000;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .instructions h2 {
            margin: 0 0 10px 0;
            font-size: 1.3rem;
        }

        .instructions p {
            margin: 8px 0;
            font-size: 0.95rem;
        }

        .hide-instructions {
            margin-top: 15px;
            padding: 10px 24px;
            background: #4a9eff;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            text-align: center;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 16px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            margin: 0 auto 15px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 38, 38, 0.95);
            color: white;
            padding: 20px;
            border-radius: 12px;
            z-index: 1001;
            max-width: 90%;
            text-align: center;
            display: none;
        }

        .gps-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            z-index: 999;
        }

        .gps-info p {
            margin: 4px 0;
        }
    </style>
</head>
<body>
    <!-- Instructions overlay -->
    <div id="instructions" class="instructions">
        <h2>Location-Based AR</h2>
        <p>1. Allow camera and location permissions</p>
        <p>2. Walk around to discover 3D cans</p>
        <p>3. Cans appear at specific GPS coordinates</p>
        <p style="font-size: 0.85em; margin-top: 10px;">Works best outdoors with clear GPS signal</p>
        <button class="hide-instructions" onclick="hideInstructions()">Got It</button>
    </div>

    <!-- Loading indicator -->
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p id="loading-text">Initializing GPS...</p>
    </div>

    <!-- Error message -->
    <div id="error" class="error"></div>

    <!-- GPS Info Display -->
    <div id="gps-info" class="gps-info" style="display: none;">
        <p><strong>Your Location:</strong></p>
        <p id="user-coords">Lat: -, Lon: -</p>
        <p id="distance-info">Distance to can: -</p>
    </div>

    <!-- AR Scene with Location-Based tracking -->
    <a-scene
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true; antialias: true; alpha: true;"
        loading-screen="enabled: false"
    >
        <!-- Assets -->
        <a-assets>
            <a-asset-item id="canModel" src="./doodles-can-2.glb"></a-asset-item>
        </a-assets>

        <!-- Camera with GPS -->
        <a-camera gps-new-camera="gpsMinDistance: 5"></a-camera>

        <!--
            Location-based 3D cans
            Replace latitude/longitude with actual coordinates where you want cans to appear
            Example coordinates are placeholder - update with real locations
        -->

        <!-- Can 1 - Update these coordinates to your desired location -->
        <a-entity
            gps-new-entity-place="latitude: 51.5074; longitude: -0.1278"
            id="can1"
        >
            <a-gltf-model
                src="#canModel"
                scale="2 2 2"
                rotation="0 0 0"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear;"
            ></a-gltf-model>
        </a-entity>

        <!-- Can 2 - 50 meters away from Can 1 (approximately) -->
        <a-entity
            gps-new-entity-place="latitude: 51.5079; longitude: -0.1278"
            id="can2"
        >
            <a-gltf-model
                src="#canModel"
                scale="2 2 2"
                rotation="0 0 0"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear;"
            ></a-gltf-model>
        </a-entity>

        <!-- Can 3 - Another location -->
        <a-entity
            gps-new-entity-place="latitude: 51.5074; longitude: -0.1283"
            id="can3"
        >
            <a-gltf-model
                src="#canModel"
                scale="2 2 2"
                rotation="0 0 0"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 12000; easing: linear;"
            ></a-gltf-model>
        </a-entity>

        <!-- Lighting -->
        <a-light type="ambient" color="#BBB" intensity="0.8"></a-light>
        <a-light type="directional" position="1 1 1" color="#FFF" intensity="1.0"></a-light>
    </a-scene>

    <script>
        let userLat = null;
        let userLon = null;

        // DOM elements
        const loadingEl = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const instructionsEl = document.getElementById('instructions');
        const errorEl = document.getElementById('error');
        const gpsInfoEl = document.getElementById('gps-info');
        const userCoordsEl = document.getElementById('user-coords');
        const distanceInfoEl = document.getElementById('distance-info');

        function hideInstructions() {
            instructionsEl.style.display = 'none';
        }

        function showError(message) {
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            loadingEl.style.display = 'none';
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }

        function updateGPSInfo() {
            if (userLat && userLon) {
                userCoordsEl.textContent = `Lat: ${userLat.toFixed(6)}, Lon: ${userLon.toFixed(6)}`;

                // Calculate distance to first can (update coordinates to match your can)
                const canLat = 51.5074;
                const canLon = -0.1278;
                const distance = calculateDistance(userLat, userLon, canLat, canLon);

                distanceInfoEl.textContent = `Distance to nearest can: ${distance.toFixed(1)}m`;
            }
        }

        // Listen for GPS camera updates
        window.addEventListener('load', () => {
            const camera = document.querySelector('[gps-new-camera]');

            camera.addEventListener('gps-camera-update-position', (event) => {
                userLat = event.detail.position.latitude;
                userLon = event.detail.position.longitude;

                loadingEl.style.display = 'none';
                gpsInfoEl.style.display = 'block';
                updateGPSInfo();
            });

            camera.addEventListener('gps-camera-error', (event) => {
                showError(`GPS Error: ${event.detail.message || 'Unable to access GPS'}`);
            });

            // Handle model loading
            const model = document.querySelector('#canModel');
            model.addEventListener('loaded', () => {
                loadingText.textContent = 'GPS Ready! Look around...';
                console.log('3D model loaded successfully');
            });

            model.addEventListener('error', (err) => {
                showError('Failed to load 3D model');
                console.error('Model loading error:', err);
            });

            // Update GPS info every 2 seconds
            setInterval(updateGPSInfo, 2000);
        });

        // Check for required APIs
        if (!navigator.geolocation) {
            showError('Geolocation is not supported by your browser');
        }

        // Request permissions
        if (navigator.permissions) {
            navigator.permissions.query({ name: 'geolocation' }).then((result) => {
                if (result.state === 'denied') {
                    showError('Location permission denied. Please enable location access.');
                }
            });
        }
    </script>
</body>
</html>
