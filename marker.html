<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Barcode Marker WebAR - Point your camera at a barcode or QR marker to see a 3D can in augmented reality">
    <title>Barcode Marker AR - Can Experience</title>
    
    <!-- A-Frame and AR.js - Latest stable versions -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.min.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .instructions {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            z-index: 1000;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .instructions h2 {
            margin: 0 0 10px 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .instructions p {
            margin: 5px 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .instructions a {
            color: #4dabf7;
            text-decoration: none;
        }
        
        .hide-instructions {
            margin-top: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.4);
        }

        .hide-instructions:active {
            transform: scale(0.95);
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            padding: 30px 40px;
            border-radius: 16px;
            z-index: 999;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 15px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(220, 38, 38, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            padding: 15px;
            border-radius: 12px;
            z-index: 1001;
            display: none;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 998;
            display: none;
        }

        .status-indicator.active {
            background: rgba(16, 185, 129, 0.9);
        }

        /* Prevent text selection and improve touch experience */
        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <!-- Instructions overlay -->
    <div id="instructions" class="instructions">
        <h2>ü•´ Barcode Marker AR</h2>
        <p>1. Allow camera permissions when prompted</p>
        <p>2. Point at a <strong>barcode marker #0</strong></p>
        <p>3. 3D can will appear in AR!</p>
        <p style="font-size: 0.85em; margin-top: 10px;">üí° Generate marker at <a href="https://ar-js-org.github.io/AR.js/three.js/examples/marker-training/examples/generator.html" target="_blank" style="color: #4a9eff;">AR.js Marker Generator</a></p>
        <button class="hide-instructions" onclick="hideInstructions()">Got It</button>
    </div>
    
    <!-- Loading indicator -->
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div id="loading-text">Loading AR Experience...</div>
    </div>

    <!-- Error message -->
    <div id="error" class="error-message"></div>

    <!-- Status indicator -->
    <div id="status" class="status-indicator">Ready</div>
    
    <!-- AR Scene -->
    <a-scene
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; trackingMethod: best; maxDetectionRate: 60; canvasWidth: 640; canvasHeight: 480;"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true; antialias: true; alpha: true;"
        loading-screen="enabled: false"
        gesture-detector
    >
        <!-- Assets -->
        <a-assets>
            <!-- Load the 3D can mode -->
            <a-asset-item id="canModel" src="./doodles-can-2.glb"></a-asset-item>
        </a-assets>
        
        <!-- Barcode Marker AR (compatible with QR codes) -->
        <a-marker
            type="barcode"
            value="0"
            id="marker"
            smooth="true"
            smoothCount="5"
            smoothTolerance="0.01"
            smoothThreshold="2"
        >
            <!-- Container for better positioning -->
            <a-entity id="model-container" position="0 0.5 0">
                <!-- 3D Can Model -->
                <a-gltf-model
                    id="canEntity"
                    src="#canModel"
                    position="0 0 0"
                    scale="1 1 1"
                    rotation="-90 0 0"
                    animation="property: rotation; to: -90 360 0; loop: true; dur: 10000; easing: linear;"
                    animation__scale="property: scale; from: 0 0 0; to: 1 1 1; dur: 500; easing: easeOutBack; startEvents: markerFound"
                    shadow="cast: true; receive: false"
                ></a-gltf-model>
            </a-entity>
            
            <!-- Optimized lighting -->
            <a-light type="ambient" color="#BBB" intensity="0.8"></a-light>
            <a-light type="directional" position="1 2 1" color="#FFF" intensity="1.0" castShadow="true"></a-light>
            <a-light type="point" position="0 2 0" color="#FFF" intensity="0.5"></a-light>
        </a-marker>
        
        <!-- Camer -->
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // Performance monitoring
        const perfStart = performance.now();
        let markerVisible = false;
        let modelLoaded = false;

        // DOM elements
        const loadingEl = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const instructionsEl = document.getElementById('instructions');
        const errorEl = document.getElementById('error');
        const statusEl = document.getElementById('status');
        const sceneEl = document.querySelector('a-scene');
        const markerEl = document.querySelector('#marker');
        const canEntityEl = document.querySelector('#canEntity');

        // Update loading text
        function updateLoading(text) {
            if (loadingText) loadingText.textContent = text;
        }

        // Show error message
        function showError(message) {
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => {
                    errorEl.style.display = 'none';
                }, 5000);
            }
        }

        // Update status indicator
        function updateStatus(text, active = false) {
            if (statusEl) {
                statusEl.textContent = text;
                statusEl.style.display = 'block';
                statusEl.classList.toggle('active', active);
                if (!active) {
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 2000);
                }
            }
        }

        // Hide loading indicator
        function hideLoading() {
            if (loadingEl) {
                loadingEl.style.opacity = '0';
                loadingEl.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    loadingEl.style.display = 'none';
                }, 300);
            }
        }

        // Hide instructions
        function hideInstructions() {
            if (instructionsEl) {
                instructionsEl.style.opacity = '0';
                instructionsEl.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    instructionsEl.style.display = 'none';
                }, 300);
            }
        }

        // Scene loaded
        if (sceneEl) {
            sceneEl.addEventListener('loaded', function() {
                console.log('‚úÖ AR Scene loaded');
                updateLoading('Loading 3D model...');
            });

            sceneEl.addEventListener('arjs-video-loaded', function() {
                console.log('‚úÖ Camera initialized');
                updateLoading('Initializing AR...');
            });
        }

        // Model loaded successfully
        if (canEntityEl) {
            canEntityEl.addEventListener('model-loaded', function() {
                modelLoaded = true;
                const loadTime = ((performance.now() - perfStart) / 1000).toFixed(2);
                console.log(`‚úÖ 3D Can model loaded successfully in ${loadTime}s`);
                hideLoading();
                updateStatus('AR Ready - Point at marker', false);
                
                // Auto-hide instructions after 5 seconds
                setTimeout(() => {
                    if (!markerVisible) {
                        hideInstructions();
                    }
                }, 5000);
            });

            // Model loading error
            canEntityEl.addEventListener('model-error', function(evt) {
                console.error('‚ùå Model loading error:', evt.detail);
                updateLoading('Error loading 3D model');
                showError('Failed to load 3D model. Please refresh the page.');
            });
        }

        // Marker found
        if (markerEl) {
            markerEl.addEventListener('markerFound', function() {
                markerVisible = true;
                console.log('üéØ Marker detected - Can visible!');
                updateStatus('AR Active', true);
                hideInstructions();
            });

            markerEl.addEventListener('markerLost', function() {
                markerVisible = false;
                console.log('üëÅÔ∏è Marker lost');
                updateStatus('Searching for marker...', false);
            });
        }

        // Double tap to show/hide instructions
        let lastTap = 0;
        document.addEventListener('touchend', function(e) {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0) {
                if (instructionsEl) {
                    const isHidden = instructionsEl.style.display === 'none';
                    instructionsEl.style.display = isHidden ? 'block' : 'none';
                    instructionsEl.style.opacity = isHidden ? '1' : '0';
                }
            }
            lastTap = currentTime;
        });

        // Desktop double click
        document.addEventListener('dblclick', function() {
            if (instructionsEl) {
                const isHidden = instructionsEl.style.display === 'none';
                instructionsEl.style.display = isHidden ? 'block' : 'none';
                instructionsEl.style.opacity = isHidden ? '1' : '0';
            }
        });

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('‚ùå Error:', e.message);
        });

        // Camera permission handling
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    console.log('‚úÖ Camera permission granted');
                    stream.getTracks().forEach(track => track.stop());
                })
                .catch(function(err) {
                    console.error('‚ùå Camera permission denied:', err);
                    showError('Camera access required for AR. Please allow camera permissions.');
                    updateLoading('Camera permission required');
                });
        }

        // Gesture detector component for better interaction
        AFRAME.registerComponent('gesture-detector', {
            schema: {
                element: { default: '' }
            },
            init: function() {
                this.targetElement = this.el;
            }
        });

        // Log performance metrics
        window.addEventListener('load', function() {
            const loadTime = ((performance.now() - perfStart) / 1000).toFixed(2);
            console.log(`üìä Page loaded in ${loadTime}s`);
        });
    </script>
</body>
</html>
